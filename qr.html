
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>QR Code 제작</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.15.5/xlsx.full.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
        <!--<script type="text/javascript" src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>-->
        <script src="./js/qr-code-styling.js"></script>
        <meta name="referrer" content="no-referrer-when-downgrade" />

    </head>
    <body>
        <input class="" type="radio" value="S" name="qrType" onclick="fnQrTypeChange('S');" checked>
        <label class="" for="qrType">단건</label>

        <input class="" type="radio" value="M" name="qrType" onclick="fnQrTypeChange('M');">
        <label class="" for="qrType">다건</label>
        <hr>
        
        <div id="singleArea" class="qrArea">
            <p>
                <span>QR : </span>
                <input type="text" id="qrSingle" value="http://www.tbglass.co.kr/" onkeyup="creatQRSingle(this)">    
            </p>
            <p>
                <span>중앙이미지 : </span>
                <!--
                <input type="text" id="qrSImg" value="" onkeyup="qrSingleImg(this)">    
                <input type="file" id="qrSImg" onchange="qrSingleImg(this)">     -->

                <input type="file" id="qrSImg" onchange="qrSingleImg(this)">
            </p>
            <button onclick="qrDownload('S')">다운로드</button>
            <div id="qrDrawSingle"></div>
            
        </div>

        <div id="multiArea" class="qrArea" style="display: none;">
            <input type="file" onchange="readExcel()">
            <hr>
    
            <button onclick="qrDownload('A')">전체 다운로드</button>
            <table>
                <tr>
                    <td style="width: 300px; padding: 2rem;">
                        <div id="qrDraw"></div>
                    </td>
                    <td>
                        <div id="qrList" style="overflow: auto; height: 60em;"></div>
                    </td>
                </tr>
            </table>    
        </div>
        
    </body>
    <script>
        var qrArray;
        var qrSingle;
        var qrCodeShow = new QRCodeStyling({
                width: 300,
                height: 300,
                type: "png",
                data: "",
                imageOptions: {
                    crossOrigin: "anonymous",
                    margin: 10
                }
        });
        qrCodeShow.append(document.getElementById("qrDraw"));

        window.onload = function(){
            qrSingle = new QRCodeStyling({
                width: 300,
                height: 300,
                type: "png",
                data: $("#qrSingle").val(),
                imageOptions: {
                    crossOrigin: "anonymous",
                    margin: 10
                }
            });
            qrSingle.append(document.getElementById("qrDrawSingle"));
        }

        function creatQRSingle(me){
            qrSingle.update({data: $(me).val() });
        }
        
        function qrSingleImg(me){
            //        image: "https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg",
            //qrSingle.update({image: $(me).val() });
            
            const fReader = new FileReader();
            fReader.readAsDataURL(document.getElementById("qrSImg").files[0]);

            fReader.onloadend = function(event){
                const imageElement = document.createElement('img');
                const path = event.target.result;
                imageElement.src = path;
                imageElement.style.display = 'block';

                console.log("PATH: ", path);
                
                qrSingle.update({image: imageElement});
            }
        }

        function fnQrTypeChange(type){
            $(".qrArea").hide();
            if("S" == type){
                $("#singleArea").show();
            }else {
                $("#multiArea").show();
            }
        }

        function readExcel() {
            let input = event.target;
            let reader = new FileReader();
            qrArray = new Array();

            reader.onload = function () {
                let data = reader.result;
                let workBook = XLSX.read(data, { type: 'binary' });
                workBook.SheetNames.forEach(function (sheetName) {
                    // 엑셀의 각 sheet명을 찍는다.
                    console.log('SheetName: ' + sheetName);                    
                    let rows = XLSX.utils.sheet_to_json(workBook.Sheets[sheetName]);

                    // 해당 sheet의 값들을 노출한다.
                    console.log(JSON.stringify(rows));

                    rows.forEach(function (item, i){
                        creatQR(i, item);
                    })
                })
            };
            reader.readAsBinaryString(input.files[0]);
        }

        function creatQR(n, item){
            var html = "";

            html += "<div>"; 
            html += "<p><button onclick='qrDownload(" + n + ")'>다운로드</button>  <button onclick='showQR(" + n + ")'>보기</button> <span id='qrTit" + n + "'>" + item.이름 + "</span> : " + item.목록 + "</p>"; 
//            html += "<div id='qr" + n + "' ></div>"; 
            html += "</div>"; 
            $("#qrList").append(html);

            var qrCode = new QRCodeStyling({
                width: 300,
                height: 300,
                type: "png",
                data: item.목록,
                imageOptions: {
                    crossOrigin: "anonymous",
                    margin: 20
                }
            });
            //qrCode.append(document.getElementById("qr" + n));
            qrArray.push(qrCode);
        }

        function qrDownload(n){
            if(n == 'A'){
                for(var i = 0; i < qrArray.length; i++){
                    qrArray[i].download({ name: $("#qrTit" + i).text(), extension: "png" });
                }
            }else if(n == 'S'){
                qrSingle.download({ name: $("#qrTit" + n).text(), extension: "png" });
            }else{
                qrArray[n].download({ name: $("#qrTit" + n).text(), extension: "png" });
            }
        }

        function showQR(n){
            var text = qrArray[n]._options.data;
            qrCodeShow.update({data: text })
        }

    /*
        
    const qrCode = new QRCodeStyling({
        width: 300,
        height: 300,
        type: "svg",
        data: "https://www.facebook.com/",
        image: "https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg",
        dotsOptions: {
            color: "#4267b2",
            type: "rounded"
        },
        backgroundOptions: {
            color: "#e9ebee",
        },
        imageOptions: {
            crossOrigin: "anonymous",
            margin: 20
        }
    });

    qrCode.append(document.getElementById("canvas"));
    qrCode.download({ name: "qr", extension: "svg" });
    */

</script>
</html>